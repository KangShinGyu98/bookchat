// rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid} {
      allow read: if request.auth != null
                  && request.auth.uid == uid;

      allow write: if request.auth != null
                   && request.auth.token.firebase.sign_in_provider != "anonymous"
                   && request.auth.uid == uid;
    }
		match /chatrooms/{chatrommId}{
    	allow read: if true;
      allow write: if request.auth != null;
      match /messages/{msgId}{
      	allow read: if true;
      	allow write: if request.auth != null;
      }
    }
    match /books/{bookId} {
      allow read: if true;
      allow write: if request.auth != null
                    && request.auth.token.firebase.sign_in_provider != "anonymous";

      match /messages/{msgId} {
        allow read: if true;
        allow create: if request.auth != null
        							&& request.auth.token.firebase.sign_in_provider != "anonymous"
        						  && request.resource.data.keys().hasOnly(['text', 'senderUid', 'senderName', 'createdAt'])
                      && request.resource.data.text is string
                      && request.resource.data.text.size() > 0
                      && request.resource.data.text.size() <= 2000
                      && request.resource.data.senderUid == request.auth.uid
                      && request.resource.data.senderName is string;
        allow update: if false;
        allow delete: if false;
      }

      match /questions/{questionId} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.auth.token.firebase.sign_in_provider != "anonymous"
                      && request.resource.data.keys().hasOnly(['question', 'createdBy', 'createdAt'])
                      && request.resource.data.question is string
                      && request.resource.data.question.size() > 0
                      && request.resource.data.createdBy is string;
        allow update: if false;
        allow delete: if false;
      }

      match /members/{memberId} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.auth.token.firebase.sign_in_provider != "anonymous"
                      && request.auth.uid == memberId;
        allow update: if request.auth != null
                      && request.auth.token.firebase.sign_in_provider != "anonymous"
                      && request.auth.uid == memberId;
        allow delete: if request.auth != null
                      && request.auth.token.firebase.sign_in_provider != "anonymous"
                      && request.auth.uid == memberId;
      }
    }
  }
}
