rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  	match /nicknames/{normalizedNickname} {
        allow get: if true;
        allow list: if false;
        allow create, update, delete: if false;
    }
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
			allow create: if false;
			allow update: if request.auth != null
                && request.auth.uid == uid
                && request.resource.data.diff(resource.data)
                     .changedKeys().hasOnly(['autoSubscribe', 'notification'])
                && ( !request.resource.data.diff(resource.data).changedKeys().hasAny(['autoSubscribe'])
                     || request.resource.data.autoSubscribe is bool )
                && ( !request.resource.data.diff(resource.data).changedKeys().hasAny(['notification'])
                     || request.resource.data.notification is bool );
    	allow delete: if false;

      match /notifications/{notificationId} {
        allow read: if request.auth != null
                    && request.auth.uid == uid;
        allow create: if false;
        allow update: if request.auth != null
                  && request.auth.uid == uid
                  && request.resource.data.diff(resource.data)
                      .changedKeys().hasOnly(['read'])
                  && request.resource.data.read is bool;
    	allow delete: if false;
      }
    }
		match /chatrooms/{chatroomId}{
    	allow read: if true;
      allow write: if false;
      match /messages/{msgId}{
      	allow read: if true;
      	allow write: if false;
      }
    }
    match /books/{bookId} {
      allow read: if true;
      allow write: if false;

      match /messages/{msgId} {
        allow read: if true;
        allow write: if false;
      }
      match /ratings/{ratingId} {
      	allow read: if request.auth != null && request.auth.uid == resource.data.createdByUid;
        allow write : if false;
      }

      match /questions/{questionId} {
      //uid필드는 가려야하나
        allow read: if true;
        allow create,update : if false;
        allow delete : if request.auth != null && request.auth.uid == resource.data.createdByUid; 
      }

      match /members/{memberId} {
        allow get: if request.auth != null && request.auth.uid == memberId;
        allow list: if false;
        allow create, update, delete: if false;

      }
    }
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
